#!/bin/bash
set -e

echo "ğŸš€ Swaply QA å…¨é‡è‡ªåŠ¨åŒ–æµ‹è¯•å¥—ä»¶"
echo "======================================"

# 1) Clean & deps
echo "ğŸ“¦ 1/5: flutter clean && flutter pub get"
flutter clean
flutter pub get

# 2) Analyze
echo "ğŸ” 2/5: flutter analyze"
if ! flutter analyze --no-fatal-infos; then
    echo "âš ï¸  flutter analyze å‘ç°è­¦å‘Šï¼ˆç»§ç»­æ‰§è¡Œï¼‰"
fi

# 3) Unit/Widget tests
echo "ğŸ§ª 3/5: flutter test"
if ! flutter test; then
    echo "âŒ flutter test å¤±è´¥ï¼Œåœæ­¢æ‰§è¡Œ"
    exit 1
fi

# 4) E2E with Patrol
echo "ğŸ“± 4/5: Patrol E2E æµ‹è¯• (QA_MODE=true)"
echo "   è®¾å¤‡é€‰æ‹©: android (è‡ªåŠ¨é€‰æ‹©æ¨¡æ‹Ÿå™¨/çœŸæœº)"

# æ£€æŸ¥æ˜¯å¦æœ‰å®‰å“è®¾å¤‡å¯ç”¨
DEVICES=$(flutter devices | grep -c "android-arm64\|android-arm\|device")
if [ "$DEVICES" -eq 0 ]; then
    echo "âŒ æœªæ‰¾åˆ° Android è®¾å¤‡/æ¨¡æ‹Ÿå™¨"
    echo "   è¯·å¯åŠ¨æ¨¡æ‹Ÿå™¨æˆ–è¿æ¥çœŸæœº"
    exit 1
fi

# ä½¿ç”¨ patrol test è‡ªåŠ¨å¯åŠ¨å¹¶è¿è¡Œæµ‹è¯•
# patrol test ä¼šè‡ªåŠ¨ install+runï¼Œæ— éœ€æ‰‹åŠ¨ flutter run
echo "   æ‰§è¡Œ: patrol test -d android --dart-define=QA_MODE=true integration_test/app_full_smoke_test.dart"
if ! patrol test -d android --dart-define=QA_MODE=true integration_test/app_full_smoke_test.dart; then
    echo "âŒ Patrol E2E æµ‹è¯•å¤±è´¥"
    echo "   æŸ¥çœ‹ä¸Šæ–¹æ—¥å¿—è·å–è¯¦ç»†ä¿¡æ¯"
    exit 1
fi

# 5) æ±‡æ€»è¾“å‡º
echo "âœ… 5/5: æ‰€æœ‰æµ‹è¯•é€šè¿‡ï¼"
echo ""
echo "ğŸ“Š æµ‹è¯•å¥—ä»¶å®Œæˆï¼š"
echo "   - flutter analyze âœ…"
echo "   - flutter test âœ…"
echo "   - Patrol E2E (4ä¸ªæµ‹è¯•) âœ…"
echo ""
echo "ğŸ‰ å…¨é‡è‡ªåŠ¨åŒ–æµ‹è¯•èƒ½åŠ›å·²å°±ç»ªï¼"